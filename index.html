<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <title>IoT Environmental Monitoring</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      background-image: linear-gradient(to bottom, #205781, #4F959D, white);
      padding: 20px;
      margin: 0;
    }

    h1 {
      margin-bottom: 30px;
      color: #ffffff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }

    .sensor-container, .led-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 40px;
    }

    .sensor-box, .led {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      min-width: 180px;
      transition: transform 0.2s ease, background 0.3s ease;
    }

    .sensor-box:hover, .led:hover {
      background-image: linear-gradient(to bottom, #27548A, #4F959D);
      color: #fff;
      transform: scale(1.05);
    }

    .cart {
      background: #ffffffcc;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      max-width: 700px;
      margin: 0 auto;
    }

    i:hover {
        transform: scale(1.2);
        transition: 0.3s ease;
        opacity: 0.8;
    }


    canvas {
      max-width: 100%;
    }

    .led i:hover {
        transform: scale(1.2);
        transition: 0.3s ease;
        opacity: 0.8;
    }

  </style>
</head>
<body>
  <h1>Environmental Monitoring IoT</h1>
  <div class="sensor-container">
    <div class="sensor-box">
      <h2><i class="fas fa-thermometer-half" style="color: #a12323;"></i> Suhu</h2>
      <p><span id="temperature">--</span> °C</p>
    </div>
    <div class="sensor-box">
      <h2><i class="fas fa-tint" style="color: #00bcd4;"></i> Kelembaban </h2>
      <p><span id="humidity">--</span> %</p>
    </div>
    <div class="sensor-box">
      <h2><i class="fa-solid fa-tachograph-digital" style="color: #b5c8e0;"></i> Jarak</h2>
      <p><span id="jarak">--</span> cm</p>
    </div>
  </div>

  <div class="led-container">
    <div class="led">
        <i id="icon-led1" class="fas fa-lightbulb" style="color: gray; font-size: 24px;"></i>
        <label for="checkbox1">LED 1</label>
        <input type="checkbox" id="checkbox1">
    </div>      
    <div class="led">
        <i id="icon-led2" class="fas fa-lightbulb" style="color: gray; font-size: 24px;"></i>
        <label for="checkbox2">LED 2</label>
        <input type="checkbox" id="checkbox2">
    </div>
    <div class="led">
        <i id="icon-led3" class="fas fa-lightbulb" style="color: gray; font-size: 24px;"></i>
        <label for="checkbox3">LED 3</label>
        <input type="checkbox" id="checkbox3">
    </div>      
  </div>
  

  <div class="cart">
    <h1>Grafik Suhu</h1>
    <canvas id="temperatureChart" width="400" height="200"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDu7wZ297Dl1iMQknNCCBDGM3fmWm8QK9E",
      authDomain: "latihanukk-9fe73.firebaseapp.com",
      databaseURL: "https://latihanukk-9fe73-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "latihanukk-9fe73",
      storageBucket: "latihanukk-9fe73.appspot.com",
      messagingSenderId: "994327720460",
      appId: "1:994327720460:web:ac7b89d2abf25d7936b429"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tempEl = document.getElementById("temperature");
    const humEl = document.getElementById("humidity");
    const jarakEl = document.getElementById("jarak");

    const ledRef = ref(db, 'dataLed');
    const sensorRef = ref(db, 'dataSensor');
    const jarakRef = ref(db, 'dataUltrasonic');

    onValue(ledRef, (snapshot) => {
        updateLEDStatus(snapshot);
    });



    document.querySelectorAll("input[type='checkbox']").forEach((cb, i) => {
      cb.addEventListener("change", () => {
        const newStatus = {
            led1: document.getElementById("checkbox1").checked ? 1 : 0,
            led2: document.getElementById("checkbox2").checked ? 1 : 0,
            led3: document.getElementById("checkbox3").checked ? 1 : 0,
        };
        set(ref(db, "dataLed"), newStatus);
       }); 
    });


    onValue(sensorRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        tempEl.textContent = data.temperature.toFixed(1);
        humEl.textContent = data.humidity.toFixed(1);
        addDataToChart(data.temperature);
      }
    });

    onValue(jarakRef, (snapshot) => {
      const data = snapshot.val();
      if (data) jarakEl.textContent = data.jarak.toFixed(1);
    });

    const ctx = document.getElementById('temperatureChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Suhu (°C)',
          data: [],
          borderColor: 'rgb(255, 99, 132)',
          tension: 0.3,
          fill: false
        }]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Waktu'
            }
          },
          y: {
            min: 0,
            title: {
              display: true,
              text: 'Suhu (°C)'
            }
          }
        }
      }
    });

    function updateLEDStatus(snapshot) {
        if (snapshot.exists()) {
            const led = snapshot.val();
            Object.keys(led).forEach((key, index) => {
                const checkbox = document.getElementById(`checkbox${index + 1}`);
                const icon = document.getElementById(`icon-led${index + 1}`);
                
                if (checkbox) {
                    const isOn = led[key] === 1;
                    checkbox.checked = isOn;

                    if (icon) {
                        icon.className = isOn ? "fas fa-lightbulb" : "far fa-lightbulb";
                        icon.style.color = isOn ? "#fdd835" : "gray";
                    }
                }
            });
        } else {
            console.log("LED data not found");
        }
    }  


    function addDataToChart(temp) {
      const time = new Date().toLocaleTimeString();
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(temp);
      if (chart.data.labels.length > 10) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }
  </script>
</body>
</html>
